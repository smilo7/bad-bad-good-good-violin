<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Essentia.js Demo</title>
</head>
<body>
  <h1>Essentia.js Test</h1>

  <h1>Essentia.js - Upload a WAV File</h1>

  <input type="file" id="fileInput" accept=".wav" multiple />
  <pre id="output">Please upload a .wav file...</pre>

  <pre id="output"></pre>

  <div style='width: 600px; height: 600px;'><canvas id="polarChart"></canvas></div>

  <script src="https://cdn.jsdelivr.net/npm/essentia.js@0.1.0/dist/essentia-wasm.web.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/essentia.js@0.1.0/dist/essentia.js-extractor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="chart.js"></script>

  <script>
    window.addEventListener("load", () => {
      console.log("Page loaded");
      console.log("EssentiaWASM:", typeof EssentiaWASM);
      console.log("EssentiaExtractor:", typeof EssentiaExtractor);
    });
  </script>


  <!-- Run script AFTER DOM is loaded -->
  <script>
    document.getElementById("fileInput").addEventListener("change", async function(event) {
      const file = event.target.files[0];
      const out = document.getElementById("output");

      if (!file) {
        out.innerText = "No file selected.";
        return;
      }

      out.innerText = "Processing wav file";

      try {
        //Decode WAV file
        const arrayBuffer = await file.arrayBuffer();
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        const signal = audioBuffer.getChannelData(0); // mono
        const sampleRate = audioBuffer.sampleRate;

        // Initialize Essentia
        const wasmModule = await EssentiaWASM();
        const extractor = new EssentiaExtractor(wasmModule);

        // Parameters for framing
        const frameSize = 1024;
        const hopSize = 512;
        const melSpectrogram = [];
        const melBandsCount = 128//96
        // Frame-by-frame mel spectrum extraction
        for (let i = 0; i + frameSize <= signal.length; i += hopSize) {
          const frame = signal.slice(i, i + frameSize);
          const melBands = extractor.melSpectrumExtractor(frame, sampleRate);
          melSpectrogram.push(melBands); // single channel
        }
        //Display melspectrogram result
        let text = `Processed ${melSpectrogram.length} frames at ${sampleRate} Hz\n`;

        for (let i = 0; i < Math.min(5, melSpectrogram.length); i++) {
          const bands = melSpectrogram[i].slice(0, 5).map(x => x.toFixed(2)).join(", ");
          text += `Frame ${i + 1}: ${bands}\n`;
        }
        
        // Format into ONNX
        const height = melBandsCount;
        const width = 128;
        console.log(melSpectrogram.length);
        const paddedSpectrogram = [];
        for (let i = 0; i < width; i++) {
            if (i < melSpectrogram.length) {
                paddedSpectrogram.push(melSpectrogram[i]);
            } else {
                paddedSpectrogram.push(new Array(height).fill(1e-10)); // pad with zeros
            }
        }
        // flatten data and log normalize
        const flatData = new Float32Array(1 * 1 * height * width);

        // Compute log-mel
        const logMelSpectrogram = [];
        for (let x = 0; x < width; x++) {
            const logFrame = [];
            for (let y = 0; y < height; y++) {
                let val = paddedSpectrogram[x][y];
                if (!isFinite(val) || val <= 0) val = 1e-10;
                const logVal = Math.log10(val);
                logFrame.push(logVal);
            }
            logMelSpectrogram.push(logFrame);
        }

        // Flatten for mean/std calculation
        const allLogVals = logMelSpectrogram.flat();
        const mean = allLogVals.reduce((a, b) => a + b, 0) / allLogVals.length;
        const std = Math.sqrt(allLogVals.reduce((a, b) => a + (b - mean) ** 2, 0) / allLogVals.length);

        // Normalize using mean/std
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                const logVal = logMelSpectrogram[x][y];
                flatData[y * width + x] = (logVal - mean) / (std + 1e-6);
            }
        }
        const inputTensor = new ort.Tensor("float32", flatData, [1, 1, height, width]);
        console.log(inputTensor);

        
        // Run ONNX
        const session = await ort.InferenceSession.create("../../models/onnx/simple_cnn.onnx");
        const feeds = { input: inputTensor };
        const results = await session.run(feeds);
        console.log("running onnx");
        const outputTensor = results["output"];
        const logits = outputTensor.data;

        // Apply softmax to convert logits to probabilities
        function softmax(logits) {
          const maxLogit = Math.max(...logits); // For numerical stability
          const exps = logits.map(x => Math.exp(x - maxLogit));
          const sumExps = exps.reduce((a, b) => a + b, 0);
          return exps.map(x => x / sumExps);
        }

        const probabilities = softmax(logits);

        let maxLogit = -Infinity;
        let predictedClass = -1;
        console.log(logits);
        for (let i = 0; i < logits.length; i++) {
            if (logits[i] > maxLogit) {
                maxLogit = logits[i];
                predictedClass = i;
            }
        }

        const ctxPolar = document.getElementById('polarChart').getContext('2d');
        dummyData = [0.1, 0.2, 0.3, 0.8 , 0.7, 0.99]
        if (window.pieChartInstance) {
          window.pieChartInstance.destroy();
        }

        
        makePolarChart(probabilities, ctxPolar);


        console.log('chart rendered.');

        text += `
        Output shape: [${outputTensor.dims.join(", ")}]
        Raw logits: [${Array.from(logits).map(x => x.toFixed(3)).join(", ")}]
        Probabilities: [${probabilities.map(p => p.toFixed(3)).join(", ")}]
        Predicted Class: ${predictedClass} (Confidence: ${(probabilities[predictedClass] * 100).toFixed(2)}%)
        `;


        out.innerText = text;
      } catch (err) {
        out.innerText = "‚ùå Error: " + err.message;
        console.error(err);
      }
    });


  </script>
</body>
</html>
